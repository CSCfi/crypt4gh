CC     = @CC@
CFLAGS = @CFLAGS@ -fPIC -I@srcdir@ @DEFS@
LIBS   = @LIBS@

prefix=@prefix@
exec_prefix=@exec_prefix@
BINDIR = @bindir@

ifdef DEBUG
CFLAGS += -DDEBUG=$(DEBUG) -g
endif

.PHONY: all clean distclean install install-crypt4gh install-crypt4gh-keygen
.SUFFIXES: .c .o

all: crypt4gh crypt4gh-keygen

crypt4gh: main.o passphrase.o cli.o
	@echo "Linking objects into $@"
	@$(CC) $(CFLAGS) -o $@ $(LIBS) $^

crypt4gh-keygen: keygen.o passphrase.o cli.o
	@echo "Linking objects into $@"
	@$(CC) $(CFLAGS) -o $@ $(LIBS) $^

%.o: %.c
ifdef DEBUG
	@echo "Compiling $< (debug: $(DEBUG))"
else
	@echo "Compiling $<"
endif
	@$(CC) $(CFLAGS) -c -o $@ $<

$(BINDIR):
	@echo "Creating bin dir: $(BINDIR)"
	@install -d $(BINDIR)

install-crypt4gh: crypt4gh | $(BINDIR)
	@echo "Installing $< into $(BINDIR)"
	@install -m 755 $< $(BINDIR)
install-crypt4gh-keygen: crypt4gh-keygen | $(BINDIR)
	@echo "Installing $< into $(BINDIR)"
	@install -m 755 $< $(BINDIR)

install: install-crypt4gh install-crypt4gh-keygen

clean:
	-rm -f crypt4gh crypt4gh-keygen main.o keygen.o passphrase.o cli.o

distclean: clean
	-rm -f Makefile


###################################
## Dependencies
###################################
depend: depend-rebuild
	rm -f .depend.bak

depend-rebuild:
	mv .depend .depend.old
	rm -f config.h .depend
	touch config.h .depend
	makedepend -w1000 -Y. -f .depend *.c 2>/dev/null
	(echo '# Automatically generated by makedepend.'; \
	 echo '# Run "make depend" to rebuild.'; sort .depend ) >.depend.tmp
	mv .depend.tmp .depend
	rm -f .depend.bak
	mv .depend.old .depend.bak
	rm -f config.h

depend-check: depend-rebuild
	cmp .depend .depend.bak || (echo .depend stale && exit 1)

# @DEPEND@
